{% extends "base.html" %}

{% block title %}3D Campus Map - Sport Room Booking{% endblock %}

{% block extra_css %}
<style>
  body {
    margin: 0;
    overflow: hidden;
  }

  #viewer-container {
    position: fixed;
    top: 56px;
    /* Account for navbar height */
    left: 0;
    width: 100%;
    height: calc(100vh - 56px);
    z-index: 1;
  }

  .legend-panel {
    position: fixed;
    top: 70px;
    right: -300px;
    width: 280px;
    height: calc(100vh - 80px);
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ddd;
    border-radius: 8px 0 0 8px;
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
    backdrop-filter: blur(10px);
  }

  .legend-panel.open {
    right: 0;
  }

  .legend-toggle {
    position: fixed;
    top: 80px;
    right: 10px;
    z-index: 1001;
    background: rgba(0, 123, 255, 0.9);
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    backdrop-filter: blur(10px);
  }

  .legend-toggle:hover {
    background: rgba(0, 123, 255, 1);
  }

  .legend-btn {
    flex: 1;
    margin-right: 5px;
    text-align: left;
    font-size: 0.85em;
  }

  .legend-zoom {
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
  }

  .building-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
  }

  .info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
  }

  .status-active {
    color: #28a745;
    font-weight: bold;
  }

  .status-expired {
    color: #dc3545;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block content %}
<div id="viewer-container"></div>

<!-- Legend Toggle Button -->
<button id="legendToggle" class="legend-toggle">
  <i class="bi bi-list"></i> Buildings
</button>

<!-- Legend Panel -->
<div id="legendPanel" class="legend-panel">
  <div class="p-3">
    <h5 class="mb-3"><i class="bi bi-building"></i> Campus Buildings</h5>

    <div class="mb-4">
      <h6 class="text-success"><i class="bi bi-check-circle"></i> Sports Facilities</h6>
      <ul id="legendSportsList" class="list-unstyled"></ul>
    </div>

    <div class="mb-4">
      <h6 class="text-info"><i class="bi bi-info-circle"></i> Other Buildings</h6>
      <ul id="legendOtherList" class="list-unstyled"></ul>
    </div>

    <div class="mt-4 p-3 bg-light rounded">
      <small class="text-muted">
        <i class="bi bi-mouse"></i> Click on buildings to view details<br>
        <i class="bi bi-zoom-in"></i> Use mouse wheel to zoom<br>
        <i class="bi bi-arrows-move"></i> Drag to rotate view
      </small>
    </div>
  </div>
</div>

<!-- Building Detail Modal -->
<div class="modal fade" id="buildingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-building-title">
          <i class="bi bi-building"></i> Building Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <img id="buildingImage" src="/static/images/default-building.jpg" alt="Building" class="building-image">
          </div>
          <div class="col-md-6">
            <div class="info-card">
              <h6><i class="bi bi-tag"></i> Building Code</h6>
              <p id="buildingCode" class="mb-0">-</p>
            </div>
            <div class="info-card">
              <h6><i class="bi bi-people"></i> Capacity</h6>
              <p id="buildingCapacity" class="mb-0">-</p>
            </div>
            <div class="info-card">
              <h6><i class="bi bi-gear"></i> Facilities</h6>
              <p id="buildingFacilities" class="mb-0">-</p>
            </div>
          </div>
        </div>

        <!-- Sports Room Schedule Section -->
        <div id="scheduleSection" style="display: none;">
          <hr>
          <h6><i class="bi bi-calendar-check"></i> Current Bookings</h6>
          <div class="table-responsive">
            <table id="bookingTable" class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Start Time</th>
                  <th>End Time</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Booking Form Section -->
        <div id="bookingFormSection" style="display: none;">
          <hr>
          {% if current_user.is_authenticated %}
          <h6><i class="bi bi-plus-circle"></i> Book This Room</h6>
          <form id="bookingForm" method="POST">
            <input type="hidden" id="input_room_code" name="room_code">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Start Date & Time</label>
                <div class="row">
                  <div class="col-7">
                    <input type="date" class="form-control" name="start_date" required>
                  </div>
                  <div class="col-5">
                    <input type="time" class="form-control" name="start_time" required>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date & Time</label>
                <div class="row">
                  <div class="col-7">
                    <input type="date" class="form-control" name="end_date" required>
                  </div>
                  <div class="col-5">
                    <input type="time" class="form-control" name="end_time" required>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-calendar-plus"></i> Submit Booking Request
              </button>
            </div>
          </form>
          {% else %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Please <a href="{{ url_for('auth.login') }}" class="alert-link">login</a> to book this room.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
  import * as THREE from "https://unpkg.com/three@0.126.1/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.126.1/examples/jsm/controls/OrbitControls.js";
  import { GLTFLoader } from "https://unpkg.com/three@0.126.1/examples/jsm/loaders/GLTFLoader.js";

  // Sports facilities that users can book
  const sportsBuildings = new Set([
    "Sport Center",
    "Track Running",
    "Lapangan Basket Outdoor 1",
    "Lapangan Basket Outdoor 2"
  ]);

  // Initialize Three.js scene
  const container = document.getElementById('viewer-container');
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xeeeeee);

  const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight - 56); // Account for navbar
  renderer.physicallyCorrectLights = true;
  renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;
  container.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minPolarAngle = 0;
  controls.maxPolarAngle = Math.PI / 2;

  // Lighting
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(10, 20, 10);
  dirLight.castShadow = true;
  scene.add(dirLight);

  // Interaction variables
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  const clickableObjects = [];
  let lastHighlighted = null;

  // Load 3D model
  const loader = new GLTFLoader();
  loader.load('/static/models/map3_GDG.glb', (gltf) => {
    const model = gltf.scene;
    scene.add(model);

    // Make building objects clickable
    model.traverse((child) => {
      if (child.isMesh && child.name) {
        child.material = child.material.clone();
        child.userData.originalColor = child.material.color.clone();
        clickableObjects.push(child);
      }
    });

    // Position camera
    const box = new THREE.Box3().setFromObject(model);
    const sphere = box.getBoundingSphere(new THREE.Sphere());
    const center = sphere.center;
    const radius = sphere.radius;

    const fov = camera.fov * (Math.PI / 180);
    const distance = (radius / Math.sin(fov / 2)) * 0.1;

    camera.position
      .copy(center)
      .add(new THREE.Vector3(distance * 1, distance * 2.8, distance * 1.5));
    camera.lookAt(center);
    controls.target.copy(center);

    camera.near = radius / 100;
    camera.far = radius * 100;
    camera.updateProjectionMatrix();
  }, undefined, (error) => {
    console.error('Error loading 3D model:', error);
    alert('Failed to load 3D campus map. Please check if the model file exists.');
  });

  // Click handler
  window.addEventListener('click', (event) => {
    if (document.querySelector('.modal.show')) return;

    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -((event.clientY - 56) / (window.innerHeight - 56)) * 2 + 1; // Account for navbar

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(clickableObjects, true);
    if (!intersects.length) return;

    const buildingName = intersects[0].object.name;
    const picked = clickableObjects.find(m => m.name === buildingName);
    if (!picked) return;

    // Highlight clicked building
    if (lastHighlighted && lastHighlighted !== picked) {
      lastHighlighted.material.color.copy(lastHighlighted.userData.originalColor);
    }
    picked.material.color.set(0xff0000);
    lastHighlighted = picked;

    showBuildingModal(buildingName);
  });

  // Animation loop
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // Handle window resize
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight - 56);
  });

  // Legend functionality
  const legendToggle = document.getElementById('legendToggle');
  const legendPanel = document.getElementById('legendPanel');
  legendToggle.addEventListener('click', () => {
    legendPanel.classList.toggle('open');
  });

  // Populate legend with building list
  function populateLegend() {
    const buildingList = [
      "Gedung A (Perkuliahan)", "Gedung B (Perkuliahan)", "Gedung Fakultas Informatika",
      "Gedung Fakultas Ilmu Terapan", "Gedung FEB FKS dan Perpustakaan",
      "Gedung Fakultas Reyasa Industri", "Gedung Fakultas Teknik Elektro",
      "Gedung Kuliah Umum", "Gedung Serba Guna", "Gedung Lingian",
      "Gedung Pasca Sarjana", "Asrama Putra", "Asrama Putri", "Gedung Rektorat",
      "Sport Center", "Student Center", "Telkom University Convention Hall",
      "Telkom University Landmark Tower", "Gedung E", "Gedung F",
      "Masjid Syamsul Ulum", "Track Running", "Lapangan Basket Outdoor 1",
      "Lapangan Basket Outdoor 2"
    ];

    const sportsUl = document.getElementById('legendSportsList');
    const otherUl = document.getElementById('legendOtherList');

    buildingList.forEach(building => {
      const li = document.createElement('li');
      li.className = 'd-flex align-items-center mb-2';

      const btnName = document.createElement('button');
      btnName.className = 'btn btn-outline-primary legend-btn';
      btnName.textContent = building;
      btnName.onclick = () => showBuildingModal(building);

      const btnZoom = document.createElement('button');
      btnZoom.className = 'btn btn-sm btn-outline-secondary legend-zoom';
      btnZoom.innerHTML = '🎯';
      btnZoom.onclick = () => animateZoomTo(building);

      li.append(btnName, btnZoom);

      if (sportsBuildings.has(building)) {
        sportsUl.appendChild(li);
      } else {
        otherUl.appendChild(li);
      }
    });
  }

  // Zoom to specific building
  function animateZoomTo(buildingName) {
    const mesh = clickableObjects.find(m => m.name === buildingName);
    if (!mesh) return;

    // Highlight zoomed building
    if (lastHighlighted && lastHighlighted !== mesh) {
      lastHighlighted.material.color.copy(lastHighlighted.userData.originalColor);
    }
    mesh.material.color.set(0xff0000);
    lastHighlighted = mesh;

    const box = new THREE.Box3().setFromObject(mesh);
    const sphere = box.getBoundingSphere(new THREE.Sphere());
    const center = sphere.center;
    const radius = sphere.radius;

    const fov = camera.fov * (Math.PI / 180);
    const distance = (radius / Math.sin(fov / 2)) * 1.2;
    const targetPos = new THREE.Vector3(distance, distance, distance).add(center);

    const startPos = camera.position.clone();
    const duration = 800;
    const startTime = performance.now();

    function tick(time) {
      const t = Math.min((time - startTime) / duration, 1);
      const ease = t * (2 - t);
      camera.position.lerpVectors(startPos, targetPos, ease);
      camera.lookAt(center);
      controls.target.copy(center);
      controls.update();
      if (t < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // Show building details modal
  function showBuildingModal(buildingName) {
    const scheduleSection = document.getElementById('scheduleSection');
    const bookingFormSection = document.getElementById('bookingFormSection');
    const isSportsBuilding = sportsBuildings.has(buildingName);

    scheduleSection.style.display = isSportsBuilding ? '' : 'none';
    bookingFormSection.style.display = isSportsBuilding ? '' : 'none';

    const inputRoomCode = document.getElementById('input_room_code');
    if (inputRoomCode) {
      inputRoomCode.value = buildingName;
    }

    // Fetch building details from API
    fetch(`/api/building/${encodeURIComponent(buildingName)}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          // Show default info for buildings not in database
          document.getElementById('modal-building-title').innerText = buildingName;
          document.getElementById('buildingCode').innerText = buildingName;
          document.getElementById('buildingCapacity').innerText = 'N/A';
          document.getElementById('buildingFacilities').innerText = isSportsBuilding ? 'Sports Facility' : 'Academic Building';
          document.getElementById('buildingImage').src = '/static/images/default-building.jpg';
        } else {
          // Show database info
          document.getElementById('modal-building-title').innerText = data.name;
          document.getElementById('buildingCode').innerText = data.code;
          document.getElementById('buildingCapacity').innerText = data.capacity || 'N/A';
          document.getElementById('buildingFacilities').innerText = data.facilities || 'N/A';
          document.getElementById('buildingImage').src = data.image_url || '/static/images/default-building.jpg';

          // Load bookings if it's a sports building
          if (isSportsBuilding && data.bookings) {
            const tbody = document.querySelector('#bookingTable tbody');
            tbody.innerHTML = '';

            if (data.bookings.length) {
              data.bookings.forEach(booking => {
                const tr = document.createElement('tr');
                const startDate = new Date(booking.start_time);
                const endDate = new Date(booking.end_time);
                const now = new Date();
                const isExpired = endDate < now;

                tr.innerHTML = `
                                <td>${startDate.toLocaleString()}</td>
                                <td>${endDate.toLocaleString()}</td>
                                <td class="${isExpired ? 'status-expired' : 'status-active'}">
                                    ${isExpired ? 'Expired' : 'Active'}
                                </td>
                            `;
                tbody.appendChild(tr);
              });
            } else {
              const tr = document.createElement('tr');
              tr.innerHTML = '<td colspan="3" class="text-center">No current bookings</td>';
              tbody.appendChild(tr);
            }
          }
        }

        new bootstrap.Modal(document.getElementById('buildingModal')).show();
      })
      .catch(err => {
        console.error(err);
        // Show default modal even if API fails
        document.getElementById('modal-building-title').innerText = buildingName;
        document.getElementById('buildingCode').innerText = buildingName;
        document.getElementById('buildingCapacity').innerText = 'N/A';
        document.getElementById('buildingFacilities').innerText = isSportsBuilding ? 'Sports Facility' : 'Academic Building';
        document.getElementById('buildingImage').src = '/static/images/default-building.jpg';

        new bootstrap.Modal(document.getElementById('buildingModal')).show();
      });
  }

  // Handle booking form submission
  const bookingForm = document.getElementById('bookingForm');
  if (bookingForm) {
    bookingForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const roomCode = formData.get('room_code');

      // Submit to booking route
      fetch(`/booking/submit`, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Booking request submitted successfully!');
            bootstrap.Modal.getInstance(document.getElementById('buildingModal')).hide();
          } else {
            alert('Failed to submit booking: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while submitting the booking.');
        });
    });
  }

  // Initialize legend
  populateLegend();

</script>
{% endblock %}